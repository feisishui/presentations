/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/Deferred","esri/kernel","esri/request","esri/PopupTemplate","esri/core/JSONSupport","esri/core/sniff","esri/core/lang","esri/geometry/SpatialReference","esri/layers/Layer","esri/layers/FeatureLayer","esri/layers/graphics/sources/FeatureLayerSource","../views/3d/support/fx3dUtils"],function(e,i,t,s,n,r,a,l,o,u,p,d,h,c,f){function v(e,t){return r({url:e,content:i.mixin({f:"json"},{}),handleAs:"json",callbackParamName:"callback"}).then(function(s){if(s._ssl&&(delete s._ssl,e=e.replace(/^http:/i,"https:")),"Feature Layer"===s.type){var n={};n.availableVizTypes=f.availableVizTypes(s.geometryType),i.mixin(n,y(s.fields)),t(null,n)}else t("FxLayer can only accecpt a feature service.")})}function y(e){var i=[],s=[],n=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],r=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y","lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X","alt","altitude","z","POINT-Z","zcenter","altitude83","altdecdeg"];return t.forEach(e,function(e){i.push(e.name);var t=e.name.toLowerCase();n.indexOf(e.type)>-1&&-1===r.indexOf(t)&&s.push(e.name)}),{displayFields:i,vizFields:s}}var g=e([d,l],{declaredClass:"esri.layers.FxLayer",viewModulePaths:{"3d":"fx3d/views/3d/layers/FxLayerView3D"},renderingInfo:null,_renderingInfoSetter:function(e,t){return null!=e.visible||this.visible?i.isObject(e)?e:t:void console.warn("The FxLayer is invisible now.")},vizType:null,_vizTypeSetter:function(e,t){return i.isString(e)&&e.length>0?e:t},displayField:null,_displayFieldSetter:function(e,i){return i===e?i:e},vizFields:null,_vizFieldsSetter:function(e,t){if(e===t)return t;var s=[];return i.isString(e)?s.push(e):s=e,s},pauseTag:null,_pauseTagSetter:function(e,i){return"boolean"==typeof e?e:"number"==typeof e?e>0||0>e?!0:!1:i},spinTag:null,_spinTagSetter:function(e,i){return"boolean"==typeof e?e:"number"==typeof e?e>0||0>e?!0:!1:i},availableVizTypes:[],wgs84Center:null,popupTemplate:null,_popupTemplateSetter:function(e,i){return e===i?i:e instanceof a?e:void 0},normalizeCtorArgs:function(e,t){if(i.isString(e)){if(f.isUrl(e))return i.mixin({},{url:e},t)}else if(i.isObject(e))return i.mixin({},{featureLayer:e},t);return e},initialize:function(){this.id=f.layerId+this.id},getDefaults:function(e){var t=this.inherited(arguments),s=e.url||e.featureLayer;return s&&(t=i.mixin(t,{disablePopup:!0,wgs84SpatialReference:new p(4326),outFields:["*"],spatialReference:null,_supportsStatistics:!1,_supportsPagination:!1,_supportsOrderBy:!1},e)),t},destroy:function(){this.pauseAnimation(),this.pauseSpinning(),this.emit("destroy-fxlayer")},load:function(){var e=this._createGraphicsSource();e.then(i.hitch(this,this._initLayerProperties)),this.addResolvingPromise(e)},_createGraphicsSource:function(){var e=new s;if(this.url){var t=new c({layer:this});t.then(i.hitch(this,function(){this.emit("graphics-source-create",{graphicsSource:t}),e.resolve(t)}),function(i){e.reject(i)})}else e.resolve();return e.promise},_initLayerProperties:function(e){this.graphicsSource=e,e.url&&(this.url=e.url),this.read(e.layerDefinition);var s=y(this.fields),n=s.vizFields,r=s.displayFields,l=null,o=null;if(i.isString(this.displayField)&&0!==this.displayField.length?(o=null,l=t.some(r,function(e){return e.toLowerCase()===this.displayField.toLowerCase()?(o=e,!0):void 0}.bind(this)),l?this.set("displayField",o):this.set("displayField",r[0])):this.set("displayField",r[0]),i.isArray(this.vizFields)&&0!==this.vizFields.length){var u=[];t.forEach(n,function(e){u.push(e.toLowerCase())}),l=[],t.forEach(this.vizFields,function(e){var i=u.indexOf(e.toLowerCase());i>-1&&l.push(n[i])}.bind(this)),l.length>0?this.set("vizFields",l):this.set("vizFields",n[0])}else this.set("vizFields",n[0]);this.availableVizTypes=f.availableVizTypes(this.geometryType),i.isString(this.vizType)&&0!==this.vizType.length?(o=null,l=t.some(this.availableVizTypes,function(e){return e.name.toLowerCase()===this.vizType.toLowerCase()?(o=e.name,!0):void 0}.bind(this)),l?this.vizType=o:this.vizType=this.availableVizTypes[0]?this.availableVizTypes[0].name:null):this.vizType=this.availableVizTypes[0]?this.availableVizTypes[0].name:null,this._supportsPagination=this.advancedQueryCapabilities.supportsPagination,this._supportsStatistics=this.advancedQueryCapabilities.supportsStatistics,this._supportsOrderBy=this.advancedQueryCapabilities.supportsOrderBy,this.spatialReference=p.fromJSON(this.extent.spatialReference),this.popupTemplate||(this.popupTemplate=new a({title:this.name,fieldInfos:this.fields?t.map(this.fields,function(e){return{fieldName:e.name,label:e.name,visible:!0}}):[],content:"{*}"})),this.vizType&&0!=this.vizType.length&&this.displayField&&0!=this.displayField.length&&i.isArray(this.vizFields)&&0!=this.vizFields.length||this.emit("fxlayer-error",{msg:"Properties of vizType, displayField, vizFields, renderingInfo, or popupTemplate is missing."})},showLabel:function(e){e&&this.emit("show-feature-label",{feature:e})},hideLabel:function(){this.emit("hide-feature-label")},startAnimation:function(){return this.visible?void(this.pauseTag=!1):void console.warn("The FxLayer is invisible now.")},pauseAnimation:function(){return this.visible?void(this.pauseTag=!0):void console.warn("The FxLayer is invisible now.")},startSpinning:function(){return this.visible?void(this.spinTag=!0):void console.warn("The FxLayer is invisible now.")},pauseSpinning:function(){return this.visible?void(this.spinTag=!1):void console.warn("The FxLayer is invisible now.")},switchVizField:function(e,s){function n(e){e>-1&&e<r.vizFields.length?r.emit("fx3d-active-viz-field",{currentVizPage:e,newRenderingInfo:s}):console.warn("invalid viz page in switchVizField(vizField).")}if(!this.visible)return void console.warn("The FxLayer is invisible now.");var r=this;if(i.isString(e)){var a=[];t.forEach(this.vizFields,function(e){a.push(e.toLowerCase())});var l=a.indexOf(e.toLowerCase());n(l)}else"number"==typeof e?n(e):console.warn("switchVizField(vizField) needs a integer id or string name as parameter.")}});return i.mixin(g,{getFieldsAndVizTypes:function(e){var t=new s;return i.isString(e)?f.isUrl(e)&&v(e,function(e,i){e?t.reject(e):t.resolve(i)}):t.reject("FxLayer can only accecpt a feature service url now."),t}}),i.mixin(g,f.EffectType),g});