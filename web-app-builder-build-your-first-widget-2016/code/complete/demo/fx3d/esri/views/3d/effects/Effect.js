/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","esri/core/Accessor","esri/core/Evented","esri/core/now","esri/geometry/support/webMercatorUtils","esri/views/3d/webgl-engine/lib/VertexBufferLayout","esri/views/3d/webgl-engine/lib/Util","esri/views/3d/webgl-engine/lib/gl-matrix","../webgl-engine-extensions/GLXBO","../webgl-engine-extensions/GLVerTexture","../support/fx3dUtils"],function(e,i,t,n,r,s,a,h,o,d,_,l,f){var c,u,g,p,y,m=d.vec2,v=i([n,r],{declaredClass:"esri.views.3d.effects.Effect",effectName:"Effect",constructor:function(i){this._view=i.view,this._layerView=i.layerView,this._renderCoordsHelper=i.view.renderCoordsHelper,this._renderSpatialReference=i.view.renderSpatialReference,this._layer=i.layer,this._currentVizPage=0,this._preVizId=-1,this._repeatCount=0,this._isReachedRepeatLimit=!1,this._vizFieldDefault="default",this._vizFields=i.layer.vizFields,this._vizFieldMinMaxs={},this._vizFieldMinMaxs[this._vizFieldDefault]={min:0,max:0},t.forEach(this._vizFields,function(e){this._vizFieldMinMaxs[e]={min:null,max:null}}.bind(this)),this._eventHandlers=[],this._vizFieldVerTextureSize=m.create(),this._vizFieldVerTextures={},this._eventHandlers.push(this._layer.on("fx3d-add-graphics",e.hitch(this,this._addGraphicsHandler))),this._eventHandlers.push(this._layer.on("fx3d-active-viz-field",e.hitch(this,this._activeVizFieldHandler))),this._eventHandlers.push(this._layer.watch("renderingInfo",this._renderingInfoChange.bind(this))),this._gl=null,this._shaderSnippets=null,this._material=null,this._toAddGraphicsIndex=0,this._addedGraphicsCount=0,this._addedGraphics=[],this._resetState(),this._resetTime(),this._pause=!1,this._eventHandlers.push(this._layer.watch("pauseTag",function(e,i,t){this._pause=e,e?e&&(this._pausedTime=this.time):this._lastTime=s()}.bind(this))),this._addLayerWatchHandler("visible"),this.renderingInfo={visible:!0,repeat:5,transparency:100,animationInterval:5},this.orderId=0},_addLayerWatchHandler:function(i){e.isString(i)&&this._eventHandlers.push(this._layer.watch(i,function(e,t,n){this.renderingInfo[n]=e,"visible"===i.toLowerCase()&&(e?this._lastTime=s():e||(this._pausedTime=this.time))}.bind(this)))},_resetState:function(){this.ready=!1,this._pause=!1,this._vacDirty=!0,this._shapeDirty=!0,this._isAddingGeometry=!1,this._renderingInfoDirty=!0,this._colourMapDirty=!0,this._colorBarDirty=!0,this._shadersReady=!1,this._isReachedRepeatLimit=!1,this._firstAnimatedTo=!1},_resetTime:function(){this.time=this._lastTime=0,this._pausedTime=0},destroy:function(){t.forEach(this._eventHandlers,function(e){"function"==typeof e.remove&&e.remove()||"function"==typeof e.destroy&&e.destroy()}),this._resetState(),this._destroy("_material");var e=Object.getOwnPropertyNames(this._vizFieldVerTextures);t.forEach(e,function(e){this._vizFieldVerTextures[e]instanceof l&&this._vizFieldVerTextures[e].dispose()}.bind(this))},_dispose:function(e){this[e]&&(this[e].dispose(),delete this[e]),this[e]=null},_destroy:function(e){this[e]&&(this[e].destroy(),delete this[e]),this[e]=null},setContext:function(e){if(this._gl=e.gl,this._shaderSnippets=e.shaderSnippets,this._effectConfig=f.effectConfig(this.effectName),this._initRenderingInfo(this._effectConfig),this._layer&&this._layer.renderingInfo){var i=Object.getOwnPropertyNames(this._layer.renderingInfo),n=Object.getOwnPropertyNames(this.renderingInfo),r=this;t.forEach(i,function(e){n?t.some(n,function(i){return e.toLowerCase()===i.toLowerCase()?("shapetype"===e.toLowerCase()?r.renderingInfo[i]=r._layer.renderingInfo[e].toLowerCase():r.renderingInfo[i]=r._layer.renderingInfo[e],!0):void 0}):r.renderingInfo[e]=r._layer.renderingInfo[e]})}this._layer._labelDefaultHeight=this.renderingInfo.height?this.renderingInfo.height+1e3:1e5,this._vizFieldVerTextures[this._vizFieldDefault]=new l(this._gl),t.forEach(this._vizFields,function(e){this._vizFieldVerTextures[e]=new l(this._gl)}.bind(this))},_addGraphicsHandler:function(i){if(e.isArray(i.graphics)&&i.graphics.length>0&&(this._toAddGraphicsIndex=this._addedGraphicsCount,this._addedGraphicsCount+=i.graphics.length,this._addedGraphics=this._addedGraphics.concat(i.graphics),this._isAddingGeometry=!0,this._shapeDirty=!0,!this._firstAnimatedTo)){var t,n=this._addedGraphics[0];if("esriGeometryPoint"===this.layer.geometryType)t={x:n.geometry.x,y:n.geometry.y,z:n.geometry.z};else if("esriGeometryPolyline"===this.layer.geometryType){var r=n.geometry.paths[0],s=r.length;t={x:(r[0][0]+r[s-1][0])/2,y:(r[0][1]+r[s-1][1])/2,z:(r[0][2]+r[s-1][2])/2}}isNaN(t.x)&&(t.x=null),isNaN(t.y)&&(t.y=null),isNaN(t.z)&&(t.z=null),t&&null!=t.x&&null!=t.y&&(this._firstAnimatedTo=!0,this._layerView._animateTo(t))}},_activeVizFieldHandler:function(i){"number"==typeof i.currentVizPage&&((this._currentVizPage<0||this._currentVizPage>=this._vizFields.length)&&(this._currentVizPage=0),this._restoreRenderingInfo(),e.isObject(i.newRenderingInfo)&&e.mixin(this.renderingInfo,i.newRenderingInfo),this._renderingInfoChange(this.renderingInfo),this._layer._labelDefaultHeight=this.renderingInfo.height?this.renderingInfo.height+1e3:1e5,this._resetAnimation(),this._currentVizPage=i.currentVizPage,this._updateVizFieldMinMaxToLayer(),this._layerView._updateSelectedFeatureLabel(),this._emitSyncEvent())},_resetAnimation:function(){this._repeatCount=0,this._preVizId=-1,this._isReachedRepeatLimit=!1,this._resetTime(),this._layer.startAnimation()},_resetAddGeometries:function(){this._addedGraphics=[]},_allGraphics:function(){return this._layerView.getCurrentGraphics()},_renderingInfoChange:function(i,t,n){i!==t&&e.isObject(i)&&this._doRenderingInfoChange(i)},_doRenderingInfoChange:function(e){this._renderingInfoDirty=!0;var i;for(i in e)e.hasOwnProperty(i)&&this.renderingInfo.hasOwnProperty(i)&&("visible"===i.toLowerCase()?(this._layer&&(this._layer[i]=e[i]),this.renderingInfo[i]=e[i]):("repeat"===i.toLowerCase()||"animationinterval"===i.toLowerCase())&&(this._resetAnimation(),this._clampScope(e,i),this.renderingInfo[i]=e[i]))},_initRenderingInfo:function(i){this._scopes={},e.isObject(i)&&e.isArray(i.renderingInfo)&&t.forEach(i.renderingInfo,function(i){"shapetype"===i.name.toLowerCase()?this.renderingInfo[i.name]=i.defaultValue.toLowerCase():this.renderingInfo[i.name]=i.defaultValue,e.isArray(i.scope)&&(this._scopes[i.name]=i.scope)}.bind(this))},_restoreRenderingInfo:function(){if(this.renderingInfo={visible:!0,repeat:5,transparency:100,animationInterval:5},this._initRenderingInfo(this._effectConfig),this._layer&&this._layer.renderingInfo){var e=Object.getOwnPropertyNames(this._layer.renderingInfo),i=Object.getOwnPropertyNames(this.renderingInfo),n=this;t.forEach(e,function(e){i?t.some(i,function(i){return e.toLowerCase()===i.toLowerCase()?("shapetype"===e.toLowerCase()?n.renderingInfo[i]=n._layer.renderingInfo[e].toLowerCase():n.renderingInfo[i]=n._layer.renderingInfo[e],!0):void 0}):n.renderingInfo[e]=n._layer.renderingInfo[e]})}this._layer._labelDefaultHeight=this.renderingInfo.height?this.renderingInfo.height+1e3:1e5},_clampScope:function(i,t){var n=this._scopes[t];if(e.isArray(n)){if("number"!=typeof i[t]||"number"!=typeof n[0]||"number"!=typeof n[1])return;i[t]<n[0]?i[t]=n[0]:i[t]>n[1]&&(i[t]=n[1]),i[t]<0&&(i[t]=0)}},_updateRenderingInfo:function(){var e=!0;this._allGraphics().length>0&&(this._colorBarDirty?(e=this._initColorBar(),e&&(this._colorBarDirty=!1)):e=!0,this._colourMapDirty&&e?(e=this._initColourMap(),e&&(this._colourMapDirty=!1)):e=!0,this._renderingInfoDirty&&e&&(e=!0,this._renderingInfoDirty=!e))},_updateRenderingGeometry:function(){var e=!0;this._allGraphics().length>0&&(e=this._initRenderContext(),e?(e=this._initVizFieldVertextures(),this._shapeDirty=!e):this._shapeDirty=!0,this._shapeDirty===!0&&(this._isAddingGeometry=!1))},preRender:function(){this.renderingInfo.visible&&(this._shadersReady||(this._shadersReady=this._loadShaders()))},_emitSyncEvent:function(){this._layer&&this._repeatCount>0&&(this.renderingInfo.repeat<=0||this.renderingInfo.repeat>0&&this._repeatCount<=this.renderingInfo.repeat)&&this._layer.emit("sync-viz-timer",{vizPage:this._currentVizPage,repeat:this._repeatCount})},_calculateRepeatCount:function(){y=Math.floor(this.time/this.renderingInfo.animationInterval),this._preVizId!==y&&(this._repeatCount++,this._preVizId=y,this._emitSyncEvent())},_updateVizPage:function(){this.renderingInfo.repeat>0?this._repeatCount<=this.renderingInfo.repeat?this._calculateRepeatCount():this._isReachedRepeatLimit||(this._isReachedRepeatLimit=!0,this._layer.pauseAnimation(),this._layer.emit("reached-repeat-limit")):this.renderingInfo.repeat<0?(this._calculateRepeatCount(),this._isReachedRepeatLimit&&(this._isReachedRepeatLimit=!1)):this._isReachedRepeatLimit||(this._isReachedRepeatLimit=!0)},render:function(e){this.renderingInfo.visible&&(e.time=this.time,e.reachedRepeatLimit=this._isReachedRepeatLimit)},update:function(){this.renderingInfo.visible&&(this._renderingInfoDirty&&this._updateRenderingInfo(),this._shapeDirty&&this._updateRenderingGeometry(),this._renderingInfoDirty||this._shapeDirty||!this._shadersReady?this.ready=!1:this.ready=!0,this._updateSelfTime(),this._updateVizPage(),this._layer.spinTag&&this._doSpin())},_doSpin:function(){c=this._view.camera.position,u=a.webMercatorToGeographic(c),g=u.x-1,-180>=g&&(g=179),p=c.z,8e6>p&&(p=8e6),this._view.animateTo({position:[g,0,p],tilt:0,heading:0})},_bindPramsReady:function(){return this._currentVizPage>=0&&this._currentVizPage<Object.getOwnPropertyNames(this._vizFieldMinMaxs).length&&this._currentVizPage<Object.getOwnPropertyNames(this._vizFieldVerTextures).length?!0:!1},_updateSelfTime:function(){this.ready&&!this._pause&&(0!==this._lastTime?this.time=this._pausedTime+.001*(s()-this._lastTime):(this._lastTime=s(),this.time=0))},_loadShaders:function(){return!0},_initVertexLayout:function(){return!0},_initRenderContext:function(){return!0},_initVizFieldVertextures:function(){var e=this._allGraphics(),i=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),n=e.length,r=n>i?i:n;r=f.nextHighestPowerOfTwo(r);var s=n%r;s=s>0?Math.floor(n/r+1):n/r,s=f.nextHighestPowerOfTwo(s),this._vizFieldVerTextures[this._vizFieldDefault].setData(r,s,new Float32Array(r*s*4));var a,h;return t.forEach(this._vizFields,function(i){var t=new Float32Array(r*s*4);h=e[0].attributes[i],h||(h=0),(!h||"number"!=typeof h||0>h)&&(h=0);for(var o=h,d=h,_=0;n>_;_++)a=e[_].attributes,h=a[i],(!h||"number"!=typeof h||0>h)&&(h=0),t[4*_]=h,h>o&&(o=h),d>h&&(d=h);this._vizFieldVerTextures[i].setData(r,s,t),this._vizFieldMinMaxs[i].min=d,this._vizFieldMinMaxs[i].max=o,this._updateVizFieldMinMaxToLayer()}.bind(this)),m.set2(r,s,this._vizFieldVerTextureSize),!0},_updateVizFieldMinMaxToLayer:function(){this._layer._currentVizPage=this._currentVizPage,this._layer._currentVizFieldMinMax=this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]]},_initColourMap:function(){return!0},_initColorBar:function(){return!0}});return v});