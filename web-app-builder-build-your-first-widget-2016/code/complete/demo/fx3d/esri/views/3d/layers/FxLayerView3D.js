/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/promise/all","dojo/Deferred","esri/Camera","esri/geometry/support/scaleUtils","esri/views/layers/LayerView","esri/Graphic","esri/layers/GraphicsLayer","esri/geometry/Point","esri/views/3d/webgl-engine/lib/ShaderSnippets","esri/views/3d/support/projectionUtils","esri/views/3d/lib/glMatrix","esri/core/watchUtils","esri/symbols/PictureMarkerSymbol","../../../layers/graphics/controllers/SnapshotControllerExt","../effects/FxEffectRenderer","../effects/FxEffectFactory","../support/fx3dUtils","dojo/text!../effects/CommonShaders.xml"],function(e,t,i,a,r,l,s,n,h,o,c,d,u,y,_,f,v,p,g,m){var b=300,w=u.vec3d,L=u.mat4d,x=u.mat3d,C=w.create(),F=L.identity(),H=x.identity(),S=w.createFrom(0,0,1),E=e(s,{declaredClass:"esri.views.3d.layers.FxLayerView3D",constructor:function(){this._perPageScale=1},initialize:function(){this.layer.then(function(){v.init(this.view);var e=this.layer.spatialReference,i=this.layer.wgs84SpatialReference,a=w.create();d.xyzToVector(this.layer.extent.xmin,this.layer.extent.ymin,0,e,a,i);var r=w.create();d.xyzToVector(this.layer.extent.xmax,this.layer.extent.ymax,0,e,r,i),"esriGeometryPoint"===this.layer.geometryType&&(this.layer.wgs84Center={x:(a[0]+r[0])/2,y:(a[1]+r[1])/2}),this._layerEventHandles=[],this._graphicsCollection=null,this._graphicsCollectionEventHandle=null,this._graphicsControllerEventHandles=[],this._graphicsControllerLoading=!0;var l=this._initEffect();l.then(t.hitch(this,this._initGraphicsController)),this.addResolvingPromise(l),this.layer.on("destroy-fxlayer",function(){v.pause()}.bind(this)),this.layer.on("show-feature-label",t.hitch(this,this._onShowFeatureLabel)),this.layer.on("hide-feature-label",function(){this._labelsLayer&&(this._labelsLayer.clear(),this._selectedFeature=null)}.bind(this)),this.view.on("click",t.hitch(this,this._viewClicked)),this._initLabelInfo()}.bind(this))},destroy:function(){this._viewModelHandler&&(this._viewModelHandler.remove(),this._viewModelHandler=null),this._labelsLayer&&(this.view.map.remove(this._labelsLayer),delete this._labelsLayer,this._labelsLayer=null),v.destroy(this.layer,this._layerId);var e=function(e){e.remove()};this._controller.stop=!0,delete this._controller,this._controller=null,this._graphicsCollectionEventHandle&&this._graphicsCollectionEventHandle.remove(),this._graphicsControllerEventHandles.forEach(e),this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),this._layerEventHandles.forEach(e)},getCurrentGraphics:function(){return[].concat(this._graphicsCollection.toArray())},_initEffect:function(){return p.make({layer:this.layer,layerView:this,view:this.view})},_initLabelInfo:function(){this._labelsLayer=new h({id:this.layer.id+"-labelinfo-layer"}),this.view.map.add(this._labelsLayer),this.layer.watch("visible",function(e,t,i){e?this._labelsLayer&&(this._labelsLayer.visible=!0):this._labelsLayer&&(this._labelsLayer.visible=!1)}.bind(this))},_onShowFeatureLabel:function(e){if(this._labelsLayer&&this._labelsLayer.visible){if(this._selectedFeature=null,e.feature){this._labelsLayer.clear();var t=this.layer.displayField+": "+e.feature.attributes[this.layer.displayField],i=g.createTextTexture(t,14,"#ffffff","center","Arial","rgba(0,0,0,0.4)"),a=e.feature.geometry,r=new _({url:i.toDataURL(),width:i.width,height:i.height,contentType:"image/png"}),l=this.layer._labelDefaultHeight;if(this.layer._currentVizFieldMinMax&&this.layer._currentVizFieldMinMax.max>0&&"number"==typeof this.layer._currentVizPage){var s=this.layer.vizFields[this.layer._currentVizPage],h=e.feature.attributes[s];null!=h&&(l+=1e4,l*=h/this.layer._currentVizFieldMinMax.max)}isNaN(l)&&(l=1e4);var c=new o(a.x,a.y,l,a.spatialReference),d=new n(c,r,e.feature.attributes,this.layer.popupTemplate);this._labelsLayer.add(d);var u=this.view.camera.position;this.view.animateTo({position:[a.longitude,a.latitude,u.z],tilt:0,heading:0})}else this._labelsLayer.clear();this._selectedFeature=e.feature}},_updateSelectedFeatureLabel:function(){if(this._labelsLayer){var e=this._labelsLayer.graphics.toArray().length>0;this._labelsLayer.clear(),e&&this._selectedFeature&&this._onShowFeatureLabel({feature:this._selectedFeature})}},_viewClicked:function(e){if(e.graphic)this._onShowFeatureLabel({feature:e.graphic});else{if(this._labelsLayer){var t=this._labelsLayer.graphics.toArray();t.length>0&&(this._labelsLayer.clear(),this._selectedFeature=null,this.layer.emit("abandon-selected-feature"))}if(this.view&&this.view.popup.viewModel.selectedFeature){var i=this.view.popup.viewModel.selectedFeature.clone();this._onShowFeatureLabel({feature:i}),this.layer.emit("selected-feature-from-globe",{selectedFeature:i}),this.view.popup.viewModel.selectedFeature=null}}},_animateTo:function(e){if(this.view){var t=this.view.camera.position;this.view.animateTo({position:[e.x,e.y,t.z||e.z],tilt:0,heading:0})}},_initGraphicsController:function(e){this._layerId=this.layer.id,v.add(this.layer,e);var t={layer:this.layer,layerView:this,maxPageSize:b};this._controller=new f(t),y.whenTrueOnce(this.view,"basemapTerrain.ready",function(){this.then(function(){var e=null,t=this._controller.on("all-features-loaded",function(){this._graphicsControllerLoading=!1,e=this._graphicsCollection.toArray(),this.layer.emit("all-features-loaded",{graphics:[].concat(e)})}.bind(this));this._graphicsControllerEventHandles.push(t);var i=this._controller.on("query-limit-exceeded",function(){this.layer.emit("query-limit-exceeded")}.bind(this));this._graphicsControllerEventHandles.push(i),this._graphicsCollection=this._controller._graphicsCollection,this._graphicsCollectionEventHandle=this._graphicsCollection.on("change",this._collectionChangeHandler.bind(this)),this._graphicsCollection.length>0&&(e=this._graphicsCollection.toArray(),this._add([].concat(e)))}.bind(this))}.bind(this))},_getVerticalUnitValueForSR:function(e){var t=l.getUnitValueForSR(e);return t>1e5?1:t},_computeLinearTransformation:function(e,t,i){return C[0]=e.x,C[1]=e.y,C[2]=e.z||1,d.computeLinearTransformation(t,C,F,i)?F:(console.warn("Could not locate effect object properly, it might be misplaced"),null)},_getFeatureTransform:function(){if("esri.layers.FxLayer"===this.layer.declaredClass){var e=this.layer.spatialReference,t=this.view.renderSpatialReference,i=1;if(!e.equals(t)){var a=this._getVerticalUnitValueForSR(e),r=this._getVerticalUnitValueForSR(t);i=a/r}var l=this._computeLinearTransformation.bind(this),s=null;return function(a){function r(e,t){for(var i=0;i<e.length;++i)for(var a=e[i],r=0;r<a.length;++r){var l=a[r];l[2]*=t}}var n=a.geometry;1!==i&&n.hasZ&&(n.z&&(n.z*=i),n.paths&&r(n.paths),n.rings&&r(n.rings)),s=l(n,e,t),s&&(n.sx=s[12],n.sy=s[13],n.sz=s[14],L.toMat3(s,H),x.multiplyVec3(H,S,C),n.nx=C[0],n.ny=C[1],n.nz=C[2],s=null)}}return null},_collectionChangeHandler:function(e){this._add([].concat(e.added)),this._remove([].concat(e.removed))},_scaleRangeEnabled:function(){var e=this.layer.get("minScale");return null!=e&&e>0&&8e7>e||this.layer.get("maxScale")>1e3},_add:function(e){function i(e){a.layer.emit("partial-features-loaded",{allFeaturesLoaded:a.layer.allFeaturesLoaded,graphics:[].concat(e)}),a.layer.emit("fx3d-add-graphics",{graphics:[].concat(e)})}if(t.isArray(e)&&e.length>0){var a=this;this.isResolved()?i(e):this.then(function(){i(e)})}},_remove:function(e){t.isArray(e)&&e.length>0},_basemapTerrainChanged:function(e){this.elevationProvider=e,this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),e?this._tilingSchemeHandle=y.whenOnce(e,"tilingScheme",this._recreateAllGraphics.bind(this)):this._recreateAllGraphics(),e?(this._elevationUpdateEventHandle=e.on("elevation-change",this._elevationUpdateHandler.bind(this)),this.updateElevation=!1,this._layerMinMaxScaleChangeHandler()):(this._elevationUpdateEventHandle&&(this._elevationUpdateEventHandle.remove(),this._elevationUpdateEventHandle=null),this._scaleChangeEventHandle&&(this._scaleChangeEventHandle.remove(),this._scaleChangeEventHandle=null))}});return E});