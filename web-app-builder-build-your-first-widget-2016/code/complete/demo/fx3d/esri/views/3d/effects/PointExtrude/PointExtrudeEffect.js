/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","esri/core/lang","esri/views/3d/webgl-engine/lib/VertexBufferLayout","esri/views/3d/webgl-engine/lib/Util","../../webgl-engine-extensions/GLXBO","../../support/fx3dUtils","../../support/fx3dUnits","../Effect","./PointExtrudeMaterial"],function(e,t,i,s,n,r,h,o,a,d,_){var g=r.VertexAttrConstants,l=window.WebGLRenderingContext,m={Down:0,Up:1},u={Cuboid:"cuboid",Cylinder:"cylinder"},f={Cuboid:4,Cylinder:20},y=t([d],{declaredClass:"esri.views.3d.effects.PointExtrude.PointExtrudeEffect",effectName:"PointExtrude",constructor:function(t){e.hitch(this,t),this.orderId=2,this._sizeInMeters=[]},_initRenderingInfo:function(){this.renderingInfo.width=4e4,this.renderingInfo.height=8e5,this.renderingInfo.topColor=[255,255,0],this.renderingInfo.bottomColor=[0,255,0],this.renderingInfo.shapeType=u.Cylinder,this._renderingInfoDirty=!0,this._segments=f.Cylinder,this._vacDirty=!0,this._shapeDirty=!0,this.inherited(arguments)},_doRenderingInfoChange:function(e){this.inherited(arguments);var t;for(t in e)e.hasOwnProperty(t)&&this.renderingInfo.hasOwnProperty(t)&&(s.endsWith(t.toLowerCase(),"info")?o.isInforAttrChanged(this.renderingInfo[t],e[t])&&(this._renderingInfoDirty=!0):s.endsWith(t.toLowerCase(),"color")?e[t]instanceof Array&&3===e[t].length&&(this.renderingInfo[t]=e[t]):"shapetype"===t.toLowerCase()?(this._shapeDirty=!0,this._isAddingGeometry=!1,this._renderingInfoDirty=!0,this.renderingInfo[t]=e[t].toLowerCase(),this.renderingInfo[t]===u.Cuboid?this._segments=f.Cuboid:this.renderingInfo[t]===u.Cylinder&&(this._segments=f.Cylinder)):"width"===t.toLowerCase()||"height"===t.toLowerCase()||"transparency"===t.toLowerCase()?(this._clampScope(e,t),this.renderingInfo[t]=e[t]):typeof e[t]==typeof this.renderingInfo[t]&&(this.renderingInfo[t]=e[t]))},setContext:function(t){this.inherited(arguments),this._effectConfig&&e.isArray(this._effectConfig.renderingInfo)&&(this._widthUnit=null,this._heightUnit=null,i.forEach(this._effectConfig.renderingInfo,function(e){"width"===e.name.toLowerCase()?this._widthUnit=e.unit:"height"===e.name.toLowerCase()&&(this._heightUnit=e.unit)}.bind(this)))},_toMeters:function(e,t){var i=null;return this._layer.wgs84SpatialReference&&(i=a.toMeters(e,t,this._layer.wgs84SpatialReference)),i?i:t},destroy:function(){this._resetXBOs()},_resetXBOs:function(){this._dispose("_vbo"),this._dispose("_ibo")},_initVertexLayout:function(){this._vertexAttrConstants=[g.POSITION,g.AUXPOS1],this._vertexBufferLayout=new n(this._vertexAttrConstants,[3,3],[l.FLOAT,l.FLOAT]),this._material&&(this._material._vbLayout=this._vertexBufferLayout)},_initRenderContext:function(){this.inherited(arguments),this._vacDirty&&(this._initVertexLayout(),this._resetXBOs(),this._vacDirty=!1),this._geometryVertexNum=2*this._segments,this._geometryIndexNum=3*(2*this._segments+(this._segments-2)),this._vbo||(this._vbo=new h(this._gl,!0,this._vertexBufferLayout)),this._ibo||(this._ibo=new h(this._gl,!1));var e=!1;return(this.renderingInfo.shapeType===u.Cuboid||this.renderingInfo.shapeType===u.Cylinder)&&(e=this._buildPolyHedronGeometries()),e},_buildPolyHedronGeometries:function(){var e=this._isAddingGeometry?this._addedGraphics:this._allGraphics(),t=this._isAddingGeometry?this._toAddGraphicsIndex:0;if(e.length>0){var i,s,n,r,h=this._vertexBufferLayout.getStride(),o=new Float32Array(e.length*h*this._geometryVertexNum),a=new Uint32Array(e.length*this._geometryIndexNum),d=0,_=0;for(s=0;s<e.length;s++){for(i=e[s],n=0;n<this._segments;n++)d=(s*this._geometryVertexNum+n)*h,o[0+d]=i.geometry.x,o[1+d]=i.geometry.y,o[2+d]=null==i.geometry.z?1:i.geometry.z,o[3+d]=s+t,o[4+d]=n,o[5+d]=m.Down,d=(s*this._geometryVertexNum+n+this._segments)*h,o[0+d]=i.geometry.x,o[1+d]=i.geometry.y,o[2+d]=null==i.geometry.z?1:i.geometry.z,o[3+d]=s+t,o[4+d]=n,o[5+d]=m.Up,_=s*this._geometryIndexNum+6*n,r=this._geometryVertexNum*(s+t),n!==this._segments-1?(a[0+_]=n+r,a[1+_]=n+1+r,a[2+_]=n+1+this._segments+r,a[3+_]=n+r,a[4+_]=n+1+this._segments+r,a[5+_]=n+this._segments+r):(a[0+_]=n+r,a[1+_]=0+r,a[2+_]=0+this._segments+r,a[3+_]=n+r,a[4+_]=0+this._segments+r,a[5+_]=n+this._segments+r);for(r=0;r<this._segments-2;r++)_=s*this._geometryIndexNum+6*this._segments+3*r,a[0+_]=0+this._segments+(s+t)*this._geometryVertexNum,a[1+_]=1+this._segments+r+(s+t)*this._geometryVertexNum,a[2+_]=2+this._segments+r+(s+t)*this._geometryVertexNum}return this._vbo.addData(this._isAddingGeometry,o),this._ibo.addData(this._isAddingGeometry,a),this._resetAddGeometries(),!0}return!1},_loadShaders:function(){return this.inherited(arguments),this._material||(this._material=new _({gl:this._gl,vbLayout:this._vertexBufferLayout,shaderSnippets:this._shaderSnippets})),this._material.loadShaders()},render:function(t){this.inherited(arguments),this._layer.visible&&this.ready&&this._bindPramsReady()&&(this._material.bind(e.mixin({},{startVizFieldVertexture:this._vizFieldVerTextures[this._vizFieldDefault],endVizFieldVertexture:this._vizFieldVerTextures[this._vizFields[this._currentVizPage]],vizFieldVertextureSize:this._vizFieldVerTextureSize,animationInterval:this.renderingInfo.animationInterval,size:[this._toMeters(this._widthUnit,this.renderingInfo.width),this._toMeters(this._heightUnit,this.renderingInfo.height)],transparency:this.renderingInfo.transparency,topColor:o.rgba2float(this.renderingInfo.topColor),bottomColor:o.rgba2float(this.renderingInfo.bottomColor),minValue:this._vizFieldMinMaxs[this._vizFieldDefault].min>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min?this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min:this._vizFieldMinMaxs[this._vizFieldDefault].min,maxValue:this._vizFieldMinMaxs[this._vizFieldDefault].max>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max?this._vizFieldMinMaxs[this._vizFieldDefault].max:this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max,segmentsFactor:1/this._segments},t)),this._vbo.bind(this._material.getProgram()),this._ibo.bind(),this._gl.drawElements(this._gl.TRIANGLES,this._ibo.getNum(),this._gl.UNSIGNED_INT,0),this._material.release(),this._vbo.unbind(),this._ibo.unbind())}});return y});