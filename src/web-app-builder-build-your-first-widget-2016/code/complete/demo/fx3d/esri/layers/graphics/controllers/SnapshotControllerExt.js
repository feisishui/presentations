/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/promise/all","esri/core/Accessor","esri/core/Promise","esri/core/Evented","esri/tasks/support/Query","esri/core/Collection"],function(e,t,i,r,s,n,a,l){var u=r.createSubclass([s,n],{declaredClass:"esri.layers.graphics.controllers.SnapshotControllerExt",constructor:function(){this._graphicsCollection=new l,this._addFeatures=this._addFeatures.bind(this),this._nextQuery=this._nextQuery.bind(this),this._queryError=this._queryError.bind(this),this._queryExtent=null,this._queryExtentHandle=null,this.stop=!1,this._sr=null},initialize:function(){var e=i([this.layer,this.layerView]).then(function(){this._sr=this.layer.wgs84SpatialReference,this.graphicsSource=this.layer.graphicsSource,this.addItemsFunc=this._graphicsCollection.addMany||this._graphicsCollection.addItems}.bind(this));this.addResolvingPromise(e),this.then(this._startQuerying.bind(this))},destroy:function(){delete this._graphicsCollection,this._graphicsCollection=null},_startQuerying:function(){this._initializeExtent(),this._queryAll()},_initializeExtent:function(){if(this.extentAccessor){var e=this.extentAccessor.get(this.extentProperty);this._queryExtent=e&&e.clone(),this._queryExtent&&(this._queryExtentHandle=this.extentAccessor.watch(this.extentProperty,function(){this._queryExtent=null,this._queryExtentHandle.remove(),this._queryExtentHandle=null,this.isFulfilled()&&(this._graphicsCollection.clear(),this._queryAll())}.bind(this)))}else this._queryExtent=null,this._queryExtentHandle=null},_extentsEqual:function(e,t){return null==e&&null==t?!0:null==e||null==t?!1:e.equals(t)},_queryAll:function(){var e=this.layer,t=(this.layerView,e.advancedQueryCapabilities||{}),i=!!t.supportsPagination,r=new a;r.where=e.definitionExpression||"1=1",r.outFields=e.outFields,r.returnGeometry=!0,r.outSpatialReference=this._sr,r.returnZ=e.hasZ&&e.returnZ||null,r.returnM=e.hasM&&e.returnM||null,r.geometry=this._queryExtent,i&&(this.pageSize=null===this.maxPageSize?e.maxRecordCount:Math.min(e.maxRecordCount,this.maxPageSize),r.num=this.pageSize),this._query(r,i?0:null,this._queryExtent)},_query:function(e,i,r){if(!this.stop){var s;null!=i&&(e.start=i,s=i+this.pageSize),this.graphicsSource&&this.graphicsSource.queryFeatures(e).then(t.hitch(this,this._nextQuery,e,s,r)).then(this._addFeatures,this._queryError)}},_addFeatures:function(e){if(e){for(var t=0;t<e.features.length;++t){var i=e.features[t];i.popupTemplate=this.layer.popupTemplate,this.featureTransform&&this.featureTransform(i)}this.graphicsSource&&("function"==typeof this.addItemsFunc&&this.addItemsFunc.call(this._graphicsCollection,e.features),e.nextQueryStarted?(this.layer.allFeaturesLoaded=!1,this.emit("query-limit-exceeded")):(this.layer.allFeaturesLoaded=!0,this.emit("all-features-loaded")))}return e},_nextQuery:function(e,t,i,r){var s=!1;if(this._extentsEqual(i,this._queryExtent)&&!this.stop&&r)return r.exceededTransferLimit&&null!=t&&(this._query(e,t,i),s=!0),r.nextQueryStarted=s,r},_queryError:function(){}});return u});